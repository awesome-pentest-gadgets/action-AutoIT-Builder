name: CI
on: 
  push:
  schedule:
    - cron:  "0 2 * * *"
permissions:
  contents: write
jobs:
  build-and-deploy:
    concurrency: ci-${{ github.ref }} # Recommended if you intend to make multiple deployments in quick succession. 
    runs-on: windows-latest
    steps:
      # ----------------------------------------------------------------

      - name: Checkout 🛎️
        uses: actions/checkout@v3

      # ----------------------------------------------------------------

      - name: Prepare files
        run: |
          mkdir C:\"Program Files (x86)"\AutoIt3\Aut2Exe\input
          mkdir C:\"Program Files (x86)"\AutoIt3\Aut2Exe\output
          Copy-Item "input\*" -Destination C:\"Program Files (x86)"\AutoIt3\Aut2Exe\input

      # ----------------------------------------------------------------

      - name: Install Autoit
        run: |
          cd compiler
          if (!(Test-Path "C:\"Program Files (x86)"\AutoIt3\Aut2Exe\Aut2exe.exe")) { ./autoit-v3-setup.exe /S }

      - name: Compile
        run: |
          cd C:\"Program Files (x86)"\AutoIt3\Aut2Exe
          ./Aut2exe.exe /in "input/input.au3" /out output/input.exe /icon input/input.ico /comp 4 /x64

      - name: Dynamically set MY_DATE environment variable
        run: echo "RELEASE_DATE=$(date --rfc-3339=date)" >> ${GITHUB_ENV}

      - name: Upload
        uses: actions/upload-artifact@v2
        with:
          name: AutoITBuilder_${{ GITHUB_SHA }}
          path: C:\Program Files (x86)\AutoIt3\Aut2Exe\output
          if-no-files-found: error